services:
  winnonah:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_CLIENTVAR: "clientvar"
    restart: always
    working_dir: /app
    image: winnonah
    container_name: winnonah
    environment:
     - DATABASE_URL=${DOCKER_DATABASE_URL}
     - AUTH_SECRET=${AUTH_SECRET}
     - AUTH_TRUST_HOST=true
     - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
     - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
     - AUTH_URL=${AUTH_URL}
     - PROVIDER_CREDENTIALING_ID=${PROVIDER_CREDENTIALING_ID}
     - PROVIDER_CREDENTIALING_RANGE=${PROVIDER_CREDENTIALING_RANGE}
     - OFFICE_ADDRESSES=${OFFICE_ADDRESSES}
     - ASANA_TOKEN=${ASANA_TOKEN}
     - ASANA_WORKSPACE=${ASANA_WORKSPACE}
     - REDIS_HOST=${REDIS_HOST}

  driftwood-db:
    image: mysql
    container_name: driftwood-db
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    ports:
      - 3306:3306
    volumes:
      - db-data:/var/lib/mysql

  redis:
    image: redis:alpine
    container_name: redis-winnonah
    restart: always

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-winnonah
    command: tunnel --no-autoupdate run --token
      ${CF_TOKEN}
    restart: always

volumes:
  db-data:
